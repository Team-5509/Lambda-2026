#!/bin/sh
set -e

# Try to find Java for environments like GitHub Desktop that might not have it in PATH
if ! command -v java >/dev/null 2>&1 && [ -z "$JAVA_HOME" ]; then
    # Check common WPILib locations (Windows)
    if [ -d "C:/Users/Public/wpilib/2026/jdk" ]; then
        export JAVA_HOME="C:/Users/Public/wpilib/2026/jdk"
    elif [ -d "C:/Users/Public/wpilib/2025/jdk" ]; then
        export JAVA_HOME="C:/Users/Public/wpilib/2025/jdk"
    # Check common WPILib locations (macOS/Linux)
    elif [ -d "$HOME/wpilib/2026/jdk" ]; then
        export JAVA_HOME="$HOME/wpilib/2026/jdk"
        [ -d "$JAVA_HOME/Contents/Home" ] && export JAVA_HOME="$JAVA_HOME/Contents/Home"
    elif [ -d "$HOME/wpilib/2025/jdk" ]; then
        export JAVA_HOME="$HOME/wpilib/2025/jdk"
        [ -d "$JAVA_HOME/Contents/Home" ] && export JAVA_HOME="$JAVA_HOME/Contents/Home"
    elif [ -d "$HOME/.jdk/jdk-17.0.16" ]; then
        export JAVA_HOME="$HOME/.jdk/jdk-17.0.16"
    # Fallback to /usr/libexec/java_home on macOS
    elif [ -x /usr/libexec/java_home ]; then
        export JAVA_HOME=$(/usr/libexec/java_home -v 17 2>/dev/null || /usr/libexec/java_home 2>/dev/null)
    fi

    if [ -n "$JAVA_HOME" ]; then
        export PATH="$JAVA_HOME/bin:$PATH"
    fi
fi

if [ "$PRE_COMMIT_SKIP_GRADLE_BUILD" = "true" ]; then
    echo "[pre-commit] Skipping Gradle builds"
else
    echo "[pre-commit] Running Gradle check..."
    # Determine if we are on Windows for GitHub Desktop compatibility
    case "$(uname)" in
        MSYS*|MINGW*|CYGWIN*) is_windows=true ;;
        *) is_windows=false ;;
    esac

    if [ "$is_windows" = true ] && [ -f "gradlew.bat" ]; then
        ./gradlew.bat check
    else
        # Ensure gradlew is executable on Unix systems
        [ "$is_windows" = false ] && chmod +x gradlew 2>/dev/null
        ./gradlew check
    fi
fi